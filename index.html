<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RiskManager - Gestión de Riesgos Cyber</title>
    <link rel="stylesheet" href="style.css">
    <!-- Using FontAwesome for icons (CDN) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>

    <!-- Sidebar Navigation -->
    <nav class="sidebar">
        <div class="logo-area">
            <i class="fa-solid fa-shield-halved logo-icon"></i>
            <span>RiskManager</span>
        </div>
        <ul class="nav-links">
            <li><button class="nav-btn active" onclick="switchTab('dashboard')"><i class="fa-solid fa-chart-line"></i>
                    Dashboard</button></li>
            <li><button class="nav-btn" onclick="switchTab('assets')"><i class="fa-solid fa-server"></i>
                    Activos</button></li>
            <li><button class="nav-btn" onclick="switchTab('risks')"><i class="fa-solid fa-triangle-exclamation"></i>
                    Gestión de Riesgos</button></li>
            <li><button class="nav-btn" onclick="switchTab('treatment')"><i class="fa-solid fa-user-doctor"></i>
                    Tratamiento</button></li>
            <li><button class="nav-btn" onclick="switchTab('vulnerabilities')"><i class="fa-solid fa-shield-virus"></i>
                    Vulnerabilidades</button></li>
            <li><button class="nav-btn" onclick="switchTab('compliance')"><i class="fa-solid fa-check-circle"></i>
                    Cumplimiento</button></li>
            <li><button class="nav-btn" onclick="switchTab('iso-controls')"><i class="fa-solid fa-book"></i>
                    ISO 27002</button></li>
            <li><button class="nav-btn" onclick="switchTab('audit')"><i class="fa-solid fa-clipboard-list"></i>
                    Auditoría</button></li>
            <li><button class="nav-btn" onclick="switchTab('reports')"><i class="fa-solid fa-file-pdf"></i>
                    Reportes</button></li>
        </ul>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <header>
            <h2 id="page-title">Dashboard General</h2>
            <div class="user-profile">
                <div class="notification-area" style="margin-right: 20px; position: relative; cursor: pointer;"
                    onclick="toggleNotifications()">
                    <i class="fa-solid fa-bell" style="font-size: 1.2rem;"></i>
                    <span id="notif-badge" class="badge-count" style="display:none;">0</span>
                    <div id="notif-dropdown" class="dropdown-menu">
                        <div class="dropdown-header">Notificaciones</div>
                        <ul id="notif-list">
                            <!-- Populated by JS -->
                        </ul>
                    </div>
                </div>
                <i class="fa-solid fa-circle-user"></i>
                <span>Admin User</span>
            </div>
        </header>

        <div class="content-area">

            <!-- DASHBOARD VIEW -->
            <div id="dashboard" class="view-section active">
                <div class="dashboard-grid">
                    <div class="card">
                        <h3>Total Activos</h3>
                        <div class="number" id="dash-total-assets">0</div>
                    </div>
                    <div class="card">
                        <h3>Riesgos Identificados</h3>
                        <div class="number" id="dash-total-risks">0</div>
                    </div>
                    <div class="card">
                        <h3>Riesgo Promedio</h3>
                        <div class="number" id="dash-avg-risk">0.0</div>
                    </div>
                    <div class="card">
                        <h3>Controles Implementados</h3>
                        <div class="number" id="dash-controls">0</div>
                    </div>
                </div>

                <div class="form-container">
                    <h3><i class="fa-solid fa-bullhorn"></i> Estado del Sistema</h3>
                    <p style="color: var(--text-secondary); margin-top: 10px;">
                        El sistema está operando correctamente. El cálculo de riesgos se basa en la metodología ISO/IEC
                        27005 alineada a controles 27002:2022.
                    </p>
                </div>
            </div>

            <!-- ASSETS VIEW -->
            <div id="assets" class="view-section">
                <div class="section-header">
                    <h2>Inventario de Activos</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn" style="background-color: #f0ad4e; color: #fff;" onclick="syncWazuh()"><i
                                class="fa-solid fa-rotate"></i> Sincronizar Wazuh</button>
                        <button class="btn btn-primary" onclick="showAssetForm()"><i class="fa-solid fa-plus"></i> Nuevo
                            Activo</button>
                    </div>
                </div>

                <!-- Asset Form (Hidden by default) -->
                <div id="asset-form-card" class="form-container" style="display: none;">
                    <h3>Registrar Nuevo Activo</h3>
                    <form id="assetForm" onsubmit="addAsset(event)">
                        <div class="form-group">
                            <label>Nombre del Activo</label>
                            <input type="text" id="assetName" class="form-control"
                                placeholder="Ej: Servidor Web Principal" required>
                        </div>
                        <div class="form-group">
                            <label>Tipo</label>
                            <select id="assetType" class="form-control">
                                <option value="Hardware">Hardware</option>
                                <option value="Software">Software</option>
                                <option value="Datos">Datos / Información</option>
                                <option value="Personal">Personal</option>
                            </select>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label>Propietario</label>
                                <input type="text" id="assetOwner" class="form-control" placeholder="Ej: Departamento TI">
                            </div>
                            <div class="form-group">
                                <label>Ubicación</label>
                                <input type="text" id="assetLocation" class="form-control" placeholder="Ej: Data Center">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Valoración General</label>
                            <select id="assetValue" class="form-control">
                                <option value="1">Bajo (Uso interno)</option>
                                <option value="3">Medio (Operación diaria)</option>
                                <option value="5">Alto (Crítico para el negocio)</option>
                            </select>
                        </div>
                        <h4 style="margin: 15px 0 10px; color: var(--text-secondary); font-size: 0.9rem;">Tríada CIA (Confidencialidad, Integridad, Disponibilidad)</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label>Confidencialidad (1-5)</label>
                                <input type="number" id="assetConf" class="form-control" min="1" max="5" value="3">
                            </div>
                            <div class="form-group">
                                <label>Integridad (1-5)</label>
                                <input type="number" id="assetInteg" class="form-control" min="1" max="5" value="3">
                            </div>
                            <div class="form-group">
                                <label>Disponibilidad (1-5)</label>
                                <input type="number" id="assetAvail" class="form-control" min="1" max="5" value="3">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Guardar Activo</button>
                        <button type="button" class="btn"
                            style="background: transparent; border: 1px solid var(--border-color); color: var(--text-primary);"
                            onclick="hideAssetForm()">Cancelar</button>
                    </form>
                </div>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Tipo</th>
                            <th>Valoración</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="assets-table-body">
                        <!-- JS renders rows here -->
                    </tbody>
                </table>
            </div>

            <!-- RISKS VIEW -->
            <div id="risks" class="view-section">
                <div class="section-header">
                    <h2>Análisis de Riesgos</h2>
                    <button class="btn btn-primary" onclick="showRiskForm()"><i class="fa-solid fa-plus"></i> Nuevo
                        Riesgo</button>
                </div>

                <!-- Risk Form -->
                <div id="risk-form-card" class="form-container" style="display: none;">
                    <h3>Identificar Riesgo</h3>
                    <form id="riskForm" onsubmit="addRisk(event)">
                        <div class="form-group">
                            <label>Activo Afectado</label>
                            <select id="riskAssetSelect" class="form-control" required>
                                <!-- Populated by JS -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Amenaza / Vulnerabilidad</label>
                            <input type="text" id="riskThreat" class="form-control"
                                placeholder="Ej: Ataque DDoS por falta de firewall" required>
                        </div>
                        <div class="form-group">
                            <label>Probabilidad (1-5)</label>
                            <input type="number" id="riskProb" class="form-control" min="1" max="5" required>
                        </div>
                        <div class="form-group">
                            <label>Impacto (1-5)</label>
                            <input type="number" id="riskImpact" class="form-control" min="1" max="5" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Calcular y Guardar</button>
                        <button type="button" class="btn" onclick="hideRiskForm()"
                            style="background: transparent; border: 1px solid var(--border-color);">Cancelar</button>
                    </form>
                </div>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Activo</th>
                            <th>Amenaza</th>
                            <th>Prob x Imp</th>
                            <th>Nivel de Riesgo</th>
                        </tr>
                    </thead>
                    <tbody id="risks-table-body">
                        <!-- JS renders rows here -->
                    </tbody>
                </table>
            </div>

            <!-- TREATMENT VIEW -->
            <div id="treatment" class="view-section">
                <div class="section-header">
                    <h2>Tratamiento de Riesgos</h2>
                </div>
                <p style="margin-bottom: 20px; color: var(--text-secondary);">Aplique controles ISO 27002 para mitigar
                    los riesgos altos.</p>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Riesgo</th>
                            <th>Nivel Actual</th>
                            <th>Estrategia</th>
                            <th>Control Propuesto</th>
                            <th>Riesgo Residual</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody id="treatment-table-body">
                        <!-- JS renders rows here -->
                    </tbody>
                </table>
            </div>

            <!-- REPORTS VIEW -->
            <div id="reports" class="view-section">
                <div class="section-header">
                    <h2>Reportes y Documentación</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="generateExecutiveReport()"><i class="fa-solid fa-file-invoice"></i> Reporte Ejecutivo</button>
                        <button class="btn" style="background-color: #28a745; color: white;" onclick="exportRisksCSV()"><i class="fa-solid fa-file-csv"></i> Exportar Riesgos</button>
                        <button class="btn" style="background-color: #17a2b8; color: white;" onclick="exportAssetsCSV()"><i class="fa-solid fa-file-csv"></i> Exportar Activos</button>
                    </div>
                </div>
                <div class="dashboard-grid">
                    <div class="card" style="cursor: pointer;" onclick="generateExecutiveReport()">
                        <h3>Reporte Ejecutivo</h3>
                        <p style="font-size: 3rem; color: var(--accent-blue); text-align: center;"><i
                                class="fa-solid fa-file-invoice"></i></p>
                        <p style="text-align: center; margin-top: 10px;">Descargar TXT</p>
                    </div>
                    <div class="card" id="heatmap-card" style="grid-column: span 2;">
                        <h3>Mapa de Calor de Riesgos</h3>
                        <div id="heatmap-container" style="display: flex; justify-content: center; margin-top: 20px;">
                            <!-- JS renders Heatmap here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- VULNERABILITIES VIEW -->
            <div id="vulnerabilities" class="view-section">
                <div class="section-header">
                    <h2>Gestión de Vulnerabilidades</h2>
                    <button class="btn btn-primary" onclick="scanVulnerabilities()"><i class="fa-solid fa-shield-virus"></i> Escanear Vulnerabilidades</button>
                </div>
                <p style="margin-bottom: 20px; color: var(--text-secondary);">Base de datos de vulnerabilidades conocidas (CVE) que afectan a la organización.</p>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>CVE ID</th>
                            <th>Descripción</th>
                            <th>Componente Afectado</th>
                            <th>Severidad</th>
                            <th>CVSS Score</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody id="vuln-table-body">
                        <!-- JS renders rows here -->
                    </tbody>
                </table>
            </div>

            <!-- COMPLIANCE VIEW -->
            <div id="compliance" class="view-section">
                <div class="section-header">
                    <h2>Cumplimiento Normativo</h2>
                    <button class="btn btn-primary" onclick="generateComplianceReport()"><i class="fa-solid fa-file-download"></i> Generar Reporte</button>
                </div>
                <div class="dashboard-grid">
                    <div class="card">
                        <h3>ISO/IEC 27001:2022</h3>
                        <div class="number" style="color: var(--success);"><span id="comp-iso27001">0</span>%</div>
                        <p style="margin-top: 10px; color: var(--text-secondary); font-size: 0.85rem;">Gestión de Seguridad</p>
                    </div>
                    <div class="card">
                        <h3>GDPR</h3>
                        <div class="number" style="color: var(--accent-blue);"><span id="comp-gdpr">0</span>%</div>
                        <p style="margin-top: 10px; color: var(--text-secondary); font-size: 0.85rem;">Protección de Datos</p>
                    </div>
                    <div class="card">
                        <h3>PCI DSS</h3>
                        <div class="number" style="color: var(--warning);"><span id="comp-pci">0</span>%</div>
                        <p style="margin-top: 10px; color: var(--text-secondary); font-size: 0.85rem;">Seguridad de Pagos</p>
                    </div>
                    <div class="card">
                        <h3>Última Evaluación</h3>
                        <div class="number" style="font-size: 1.2rem; color: var(--text-primary);"><span id="comp-last-assessment">Nunca</span></div>
                        <p style="margin-top: 10px; color: var(--text-secondary); font-size: 0.85rem;">Fecha de Assessment</p>
                    </div>
                </div>
                <div class="form-container">
                    <h3><i class="fa-solid fa-chart-bar"></i> Estado de Cumplimiento</h3>
                    <p style="color: var(--text-secondary); margin: 15px 0;">
                        Las métricas de cumplimiento se calculan automáticamente en base a los controles implementados,
                        riesgos tratados y protección de activos críticos. Los valores reflejan el nivel de alineación
                        con las normativas internacionales de ciberseguridad.
                    </p>
                    <ul style="list-style: none; padding: 0;">
                        <li style="padding: 10px; background: var(--bg-dark); margin: 5px 0; border-radius: 4px;">
                            <i class="fa-solid fa-shield-halved" style="color: var(--success);"></i>
                            <strong>ISO 27001:</strong> Basado en cobertura de tratamiento de riesgos
                        </li>
                        <li style="padding: 10px; background: var(--bg-dark); margin: 5px 0; border-radius: 4px;">
                            <i class="fa-solid fa-lock" style="color: var(--accent-blue);"></i>
                            <strong>GDPR:</strong> Basado en protección de activos de datos personales
                        </li>
                        <li style="padding: 10px; background: var(--bg-dark); margin: 5px 0; border-radius: 4px;">
                            <i class="fa-solid fa-credit-card" style="color: var(--warning);"></i>
                            <strong>PCI DSS:</strong> Basado en controles de riesgos críticos implementados
                        </li>
                    </ul>
                </div>
            </div>

            <!-- ISO CONTROLS VIEW -->
            <div id="iso-controls" class="view-section">
                <div class="section-header">
                    <h2>Catálogo ISO/IEC 27002:2022</h2>
                </div>
                <div class="form-container">
                    <h3><i class="fa-solid fa-book"></i> Controles de Seguridad</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">
                        Consulte los controles de la norma ISO/IEC 27002:2022 para implementar en su organización.
                        Estos controles están alineados con las mejores prácticas internacionales de ciberseguridad.
                    </p>
                    <div class="form-group">
                        <label>Seleccione un Control</label>
                        <select id="isoControlSelect" class="form-control" onchange="showControlDetails()">
                            <!-- Populated by JS -->
                        </select>
                    </div>
                    <div id="control-details" style="display: none;"></div>
                </div>
                <div class="form-container">
                    <h3>Controles por Categoría</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                        <div>
                            <h4 style="color: var(--accent-blue); margin-bottom: 10px;"><i class="fa-solid fa-building"></i> Organizacionales</h4>
                            <ul style="list-style: none; padding: 0;">
                                <li style="padding: 8px; background: var(--bg-dark); margin: 5px 0; border-radius: 4px;">
                                    <strong>5.1</strong> - Políticas de seguridad
                                </li>
                                <li style="padding: 8px; background: var(--bg-dark); margin: 5px 0; border-radius: 4px;">
                                    <strong>5.7</strong> - Inteligencia de amenazas
                                </li>
                                <li style="padding: 8px; background: var(--bg-dark); margin: 5px 0; border-radius: 4px;">
                                    <strong>5.15</strong> - Control de acceso
                                </li>
                                <li style="padding: 8px; background: var(--bg-dark); margin: 5px 0; border-radius: 4px;">
                                    <strong>5.23</strong> - Seguridad en cloud
                                </li>
                            </ul>
                        </div>
                        <div>
                            <h4 style="color: var(--success); margin-bottom: 10px;"><i class="fa-solid fa-microchip"></i> Tecnológicos</h4>
                            <ul style="list-style: none; padding: 0;">
                                <li style="padding: 8px; background: var(--bg-dark); margin: 5px 0; border-radius: 4px;">
                                    <strong>8.8</strong> - Gestión de vulnerabilidades
                                </li>
                                <li style="padding: 8px; background: var(--bg-dark); margin: 5px 0; border-radius: 4px;">
                                    <strong>8.13</strong> - Respaldo de información
                                </li>
                                <li style="padding: 8px; background: var(--bg-dark); margin: 5px 0; border-radius: 4px;">
                                    <strong>8.16</strong> - Monitoreo
                                </li>
                                <li style="padding: 8px; background: var(--bg-dark); margin: 5px 0; border-radius: 4px;">
                                    <strong>8.24</strong> - Uso de criptografía
                                </li>
                                <li style="padding: 8px; background: var(--bg-dark); margin: 5px 0; border-radius: 4px;">
                                    <strong>8.28</strong> - Codificación segura
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AUDIT VIEW -->
            <div id="audit" class="view-section">
                <div class="section-header">
                    <h2>Registro de Auditoría</h2>
                    <button class="btn btn-primary" onclick="exportAuditLog()"><i class="fa-solid fa-download"></i> Exportar Log</button>
                </div>
                <p style="margin-bottom: 20px; color: var(--text-secondary);">
                    Registro completo de todas las actividades realizadas en el sistema. Últimas 20 entradas mostradas.
                </p>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Fecha/Hora</th>
                            <th>Módulo</th>
                            <th>Acción</th>
                            <th>Descripción</th>
                            <th>Usuario</th>
                        </tr>
                    </thead>
                    <tbody id="audit-table-body">
                        <!-- JS renders rows here -->
                    </tbody>
                </table>
            </div>

        </div>

        <!-- ROI VIEW -->
        <div id="roi" class="view-section">
            <div class="section-header">
                <h2>Análisis Costo-Beneficio (ROI)</h2>
            </div>
            <div class="dashboard-grid">
                <div class="card">
                    <h3>ALE Actual (Pérdida Anual)</h3>
                    <div class="number" style="color: var(--danger);">$<span id="roi-ale-current">0</span></div>
                </div>
                <div class="card">
                    <h3>Costo de Controles</h3>
                    <div class="number" style="color: var(--warning);">$<span id="roi-cost">0</span></div>
                </div>
                <div class="card">
                    <h3>Ahorro Proyectado</h3>
                    <div class="number" style="color: var(--success);">$<span id="roi-savings">0</span></div>
                </div>
                <div class="card">
                    <h3>ROI Estimado</h3>
                    <div class="number" id="roi-percent">0%</div>
                </div>
            </div>

            <div class="form-container">
                <h3>Calculadora de Retorno de Inversión</h3>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    Seleccione un riesgo tratado para estimar el ROI basado en la reducción de impacto financiero.
                </p>
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div class="form-group" style="flex: 1;">
                        <label>Riesgo Tratado</label>
                        <select id="roiRiskSelect" class="form-control" onchange="calculateROI()">
                            <option value="">-- Seleccione Riesgo --</option>
                            <!-- Populated by JS -->
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Costo del Control ($)</label>
                        <input type="number" id="controlCost" class="form-control" value="5000"
                            onchange="calculateROI()">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Valor del Activo ($)</label>
                        <input type="number" id="assetValueMoney" class="form-control" value="50000"
                            onchange="calculateROI()">
                    </div>
                </div>
            </div>
        </div>

        <!-- Evidence Modal -->
        <div id="evidence-modal" class="modal">
            <div class="modal-content">
                <span class="close-modal" onclick="closeEvidenceModal()">&times;</span>
                <h3>Gestión de Evidencias</h3>
                <p>Suba archivos (logs, capturas) que demuestren la implementación del control.</p>
                <div class="upload-area" id="drop-zone" onclick="document.getElementById('fileElem').click()">
                    <i class="fa-solid fa-cloud-arrow-up" style="font-size: 3rem; color: var(--accent-blue);"></i>
                    <p style="margin-top: 10px;">Arrastre archivos aquí o haga clic para subir</p>
                    <input type="file" id="fileElem" multiple style="display:none" onchange="handleFiles(this.files)">
                </div>
                <ul id="evidence-list" class="evidence-list">
                    <!-- Evidence items -->
                </ul>
                <button class="btn btn-primary" style="width: 100%; margin-top: 20px;" onclick="saveEvidence()">Guardar
                    Evidencia</button>
            </div>
        </div>

    </div>
    </div>

    <!-- Scripts -->
    <script src="app-api.js"></script>
</body>

</html>